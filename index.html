<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css">
  <title>Wyszukiwarka niższych cen medycznej marihuany.</title>
</head>
<body>
  <div class="background-animation"></div>
  <div class="floating-particles">
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
  </div>

  <div class="main-container">
    <h2 class="main-title">Znajdź medyczną marihuanę taniej w swoim mieście!</h2>
    <blockquote class="info-block">
      Ceny pobrano ze strony - gdziepolek.pl<br>
      Cennik jest z dnia <span id="update-date"><br></span>
    </blockquote>

    <div class="filters">
      <div class="filter-group">
        <select id="city"></select>
      </div>
      <div class="filter-group">
        <select id="producer"></select>
      </div>
      <div class="filter-group">
        <select id="strain"></select>
      </div>
      <div class="filter-group">
        <select id="thc"></select>
      </div>
    </div>

    <div id="results" class="results-container"></div>

    <div class="info-section">
      <h4>
        <p>Witaj! Skoro tu jesteś, wiedz że jest to projekt który zamierzam rozwinąć, również wydać w wersji aplikacji na telefon.</p>
        <p>Na ten moment projekt działa w wersji "beta", postaram się codziennie aktualizować cennik</p>
        <p>Jeśli doceniasz to, co robię i chcesz mnie wesprzeć, będzie mi bardzo miło! 
        <a href="https://buycoffee.to/donky" target="_blank"><img src="https://buycoffee.to/img/share-button-dark.png" style="width: 117px; height: 30px" alt="Postaw mi kawę na buycoffee.to"></a>
      </h4>
      
		<details class="changelog">
		  <summary>Changelog (kliknij, by rozwinąć)</summary>
		  <p><strong>04.06.2025</strong> | Dodano:</p>
		  <ul>
			<li>Zmienione UI.</li><br>
			<li>Status oficjalnego projektu:</li>
			<li>Nacisnij GIF aby powiększyć.</li>
			<li>
			  <a href="1update.gif" target="_blank">
				<img src="1update.gif" width="280" height="190" alt="">
			  </a>
			</li>
		  </ul><br><br>
		  <p><strong>27.05.2025</strong> | Dodano:</p>
		  <ul>
			<li>Przeniesienie do rezerwacji/apteki.</li>
			<li>420 Pharm.</li>
		  </ul><br><br>
		  <p><strong>26.05.2025</strong> | Strona jest publiczna, jest w wersji testowej.</p>
		</details>

      <details class="info">
        <summary>Status i plany (kliknij, by rozwinąć)</summary>
        <p>Wkrótce strona zostanie przeniesiona do zautomatyzowanego hostingu, co znacznie ułatwi jej obsługę.</p>
        <p>Planuję również dodać możliwość sortowania według województw oraz rozszerzyć listę dostępnych miast.</p>
        <p>Obecnie napotykam pewne trudności z serwisem GdziePoLek – uciążliwa CAPTCHA pojawia się przy każdym odświeżeniu strony.</p>
        <p>Pracuję nad rozwiązaniem tego problemu, proszę o odrobinę cierpliwości.</p>
      </details>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 _d0nky. Wszelkie prawa zastrzeżone. Jeżeli znajdziesz jakieś błędy, daj znać proszę -> #Discord: _d0nky</p>
    <div class="external-counter"><img src="https://visit-counter.vercel.app/counter.png?page=https%3A%2F%2Fmedyczna.github.io%2F&s=16&c=5fb431&bg=00000000&no=4&ff=digi&tb=&ta=" alt="visits"></div>
  </footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
  let apteki = [];
  const citySelect = document.getElementById('city');
  const strainSelect = document.getElementById('strain');
  const producerSelect = document.getElementById('producer');
  const thcSelect = document.getElementById('thc');
  const results = document.getElementById('results');

  const cityNormalizeMap = {
    "Warszawie": "Warszawa",
    "Krakowie": "Kraków",
    "Lodzi": "Łódź",
    "Wroclawiu": "Wrocław",
    "Poznaniu": "Poznań",
    "Gdansku": "Gdańsk",
    "Gdyni": "Gdynia",
    "Sopocie": "Sopot",
    "Szczecinie": "Szczecin",
    "Bydgoszczy": "Bydgoszcz",
    "Lublinie": "Lublin",
    "Bialymstoku": "Białystok",
    "Katowicach": "Katowice",
    "Gorzowie-wielkopolskim": "Gorzów Wielkopolski",
    "Rzeszowie": "Rzeszów",
    "Olsztynie": "Olsztyn",
    "Zielonej-gorze": "Zielona Góra",
    "Toruniu": "Toruń",
    "Kielcach": "Kielce"
  };

  async function loadData() {
    const res = await fetch('apteki_interaktywne.json');
    apteki = await res.json();
    populateCities();
  }

  function populateCities() {
    citySelect.innerHTML = '<option value="" disabled selected>Wybierz miasto</option>';
    const cities = new Set();
    apteki.forEach(a => cities.add(a.miasto));
	[...cities].sort().forEach(c => {
	if (!c || c.trim() === '' || c === 'undefined') return;
	const displayName = cityNormalizeMap[c] || c;
	citySelect.innerHTML += `<option value="${c}">${displayName}</option>`;
});
    producerSelect.innerHTML = '<option value="" disabled selected>Wybierz producenta</option>';
    strainSelect.innerHTML = '<option value="" disabled selected>Wybierz odmianę</option>';
    thcSelect.innerHTML = '<option value="" disabled selected>Wybierz % THC</option>';

    citySelect.addEventListener('change', () => {
      onCityChange();
      applyFilters();
    });
    producerSelect.addEventListener('change', () => {
      onProducerChange();
      applyFilters();
    });
    strainSelect.addEventListener('change', () => {
      onStrainChange();
      applyFilters();
    });
    thcSelect.addEventListener('change', applyFilters);
  }

  function onCityChange() {
    const city = citySelect.value;
    const filteredApteki = apteki.filter(a => a.miasto === city);

    const producers = new Set();
    filteredApteki.forEach(a => {
      a.produkty.forEach(p => producers.add(p.producent));
    });

    producerSelect.innerHTML = '<option value="" disabled selected>Wybierz producenta</option>';
    [...producers].sort().forEach(p => {
      producerSelect.innerHTML += `<option value="${p}">${p}</option>`;
    });

    strainSelect.innerHTML = '<option value="" disabled selected>Wybierz odmianę</option>';
    thcSelect.innerHTML = '<option value="" disabled selected>Wybierz % THC</option>';

    showAllFromCity(city);
  }

  function showAllFromCity(city) {
    const filteredApteki = apteki.filter(a => a.miasto === city);
    const produktyZMiasta = [];

    filteredApteki.forEach(apteka => {
      apteka.produkty.forEach(p => {
        produktyZMiasta.push({
          apteka,
          produkt: p
        });
      });
    });

    produktyZMiasta.sort((a, b) => a.produkt.cena - b.produkt.cena);

    results.innerHTML = '';
    produktyZMiasta.forEach(({ apteka, produkt }) => {
      results.innerHTML += `
        <div class="apteka">
          <p><strong>${apteka.adres}<br>${apteka.dostępność}</strong></p>
          <div>
            <span class="strain-name"><strong>${produkt.odmiana}</strong></span> 
            <span class="producer-name">(${produkt.producent})</span> - 
            <span class="thc-content">${produkt.thc}% THC</span><br>
            <span class="date-text">${produkt.data}</span> - 
            <span class="price">${produkt.cena.toFixed(2)} zł/g</span>
            <a href="${apteka.link_rezerwacji}" target="_blank" class="rezerwuj-link">REZERWUJ</a>
          </div>
        </div>
      `;
    });

    if (produktyZMiasta.length === 0) {
      results.innerHTML = '<p>Brak wyników.</p>';
    }
  }

  function onProducerChange() {
    const city = citySelect.value;
    const producer = producerSelect.value;

    const filteredApteki = apteki.filter(a => a.miasto === city);
    const strains = new Set();

    filteredApteki.forEach(a => {
      a.produkty.forEach(p => {
        if (p.producent === producer) {
          strains.add(p.odmiana);
        }
      });
    });

    strainSelect.innerHTML = '<option value="" disabled selected>Wybierz odmianę</option>';
    [...strains].sort().forEach(s => {
      strainSelect.innerHTML += `<option value="${s}">${s}</option>`;
    });

    thcSelect.innerHTML = '<option value="" disabled selected>Wybierz % THC</option>';
  }

  function onStrainChange() {
    const city = citySelect.value;
    const producer = producerSelect.value;
    const strain = strainSelect.value;

    if (!city || !producer || !strain) {
      thcSelect.innerHTML = '<option value="" disabled selected>Wybierz % THC</option>';
      return;
    }

    const filteredApteki = apteki.filter(a => a.miasto === city);
    const thcSet = new Set();

    filteredApteki.forEach(a => {
      a.produkty.forEach(p => {
        if (p.producent === producer && p.odmiana === strain) {
          thcSet.add(p.thc);
        }
      });
    });

    thcSelect.innerHTML = '<option value="" disabled selected>Wybierz % THC</option>';
    [...thcSet].sort((a, b) => a - b).forEach(t => {
      thcSelect.innerHTML += `<option value="${t}">${t}%</option>`;
    });
  }

  fetch('apteki_interaktywne.json')
    .then(response => response.json())
    .then(data => {
      document.getElementById('update-date').textContent = data[data.length - 1].update;
      apteki = data;
      populateCities();
    })
    .catch(err => {
      console.error('Błąd ładowania danych:', err);
    });

  function applyFilters() {
    const city = citySelect.value;
    const producer = producerSelect.value;
    const strain = strainSelect.value;
    const thc = parseFloat(thcSelect.value);

    let pasujące = [];

    apteki.forEach(apteka => {
      if (apteka.miasto !== city) return;

      const produkty = apteka.produkty.filter(p => {
        if (producer && p.producent !== producer) return false;
        if (strain && p.odmiana !== strain) return false;
        if (!isNaN(thc) && p.thc !== thc) return false;
        return true;
      });

      if (produkty.length > 0) {
        pasujące.push({ apteka, produkty });
      }
    });

    pasujące.sort((a, b) => a.produkty[0].cena - b.produkty[0].cena);

    results.innerHTML = '';
    pasujące.forEach(({ apteka, produkty }) => {
      const produktyHTML = produkty.map(p =>
        `<div>
          <span class="strain-name"><strong>${p.odmiana}</strong></span> 
          <span class="producer-name">(${p.producent})</span> - 
          <span class="thc-content">${p.thc}% THC</span><br>
          <span class="date-text">${p.data}</span> - 
          <span class="price">${p.cena.toFixed(2)} zł/g</span> 
          <a href="${apteka.link_rezerwacji}" target="_blank" class="rezerwuj-link">REZERWUJ</a>
        </div>`
      ).join('');

      results.innerHTML += `
        <div class="apteka">
          <p><strong>${apteka.adres}<br>${apteka.dostępność}</strong></p>
          ${produktyHTML}
        </div>
      `;
    });

    if (results.innerHTML === '') {
      results.innerHTML = '<p>Brak wyników.</p>';
    }
  }

  loadData();
});
</script>

</body>
</html>